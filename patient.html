<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meddo — Patient Details</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body class="dashboard-body">

  <!-- Navbar -->
  <nav class="navbar dashboard-nav" id="navbar">
    <div class="container nav-container">
      <a href="index.html" class="nav-logo">
        <span class="logo-icon">&#x1FA7A;</span> Meddo
      </a>
      <div class="nav-links" id="nav-links">
        <a href="index.html">Home</a>
        <a href="admin.html">Dashboard</a>
      </div>
      <div class="nav-doctor-info">
        <span class="doctor-avatar">DS</span>
        <span class="doctor-name">Dr. Suresh</span>
      </div>
    </div>
  </nav>

  <!-- Patient Detail -->
  <main class="dashboard-main">
    <div class="container">

      <!-- Back link -->
      <a href="admin.html" class="back-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back to Dashboard
      </a>

      <!-- Patient Header -->
      <div class="patient-header" id="patient-header">
        <!-- Populated by JS -->
      </div>

      <!-- Two column layout -->
      <div class="patient-detail-grid">

        <!-- Left: AI Summary + Insights -->
        <div class="patient-left-col">

          <!-- AI Summary Card -->
          <div class="ai-summary-card" id="ai-summary-card">
            <div class="ais-header">
              <div class="ais-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a5 5 0 0 1 5 5v3a5 5 0 0 1-10 0V7a5 5 0 0 1 5-5z"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M12 22v-2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/></svg>
              </div>
              <h3>AI-Generated Summary</h3>
              <button class="hear-ai-btn" id="hear-ai-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                  <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
                Hear Summary
              </button>
            </div>
            <div class="ais-body" id="ai-summary-body">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Insights Panel -->
          <div class="insights-panel" id="insights-panel">
            <h3 class="insights-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
              AI Insights & Patterns
            </h3>
            <div class="insights-list" id="insights-list">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="quick-stats-card" id="quick-stats">
            <!-- Populated by JS -->
          </div>

        </div>

        <!-- Right: Visit Timeline -->
        <div class="patient-right-col">
          <div class="visits-header">
            <h3 class="visits-title">Visit History</h3>
            <span class="visits-count" id="visits-count"></span>
          </div>

          <div class="visits-timeline" id="visits-timeline">
            <!-- Populated by JS -->
          </div>
        </div>

      </div>
    </div>
  </main>

  <script src="js/data.js"></script>
  <script>
    // Get patient ID from URL
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get('id');
    const patient = getPatientById(patientId);

    if (!patient) {
      document.querySelector('.dashboard-main .container').innerHTML = `
        <div class="empty-state" style="display:flex; margin-top: 100px;">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
          <p>Patient not found</p>
          <a href="admin.html" class="back-link" style="margin-top: 16px;">Go to Dashboard</a>
        </div>
      `;
    } else {
      document.title = `Meddo — ${patient.name}`;
      renderPatientPage(patient);
    }

    function renderPatientPage(p) {
      const initials = p.name.split(' ').map(n => n[0]).join('');
      const lastVisit = p.visits[p.visits.length - 1];
      const lastBP = lastVisit.details.vitals.bp || '—';

      // Header
      document.getElementById('patient-header').innerHTML = `
        <div class="ph-left">
          <div class="ph-avatar" style="background: ${getStatusColor(p.status)}20; color: ${getStatusColor(p.status)}">${initials}</div>
          <div class="ph-info">
            <h1 class="ph-name">${p.name} <span class="ph-id">${p.id}</span></h1>
            <div class="ph-meta-row">
              <span>${p.age} yrs</span>
              <span class="ph-sep">&middot;</span>
              <span>${p.gender}</span>
              <span class="ph-sep">&middot;</span>
              <span>Blood: ${p.blood_group}</span>
              <span class="ph-sep">&middot;</span>
              <span>Language: ${p.language_name}</span>
            </div>
            <div class="ph-conditions">
              ${p.conditions.map(c => `<span class="ph-condition">${c}</span>`).join('')}
            </div>
          </div>
        </div>
        <div class="ph-right">
          <span class="ph-status" style="background: ${getStatusColor(p.status)}; color: white">
            ${getStatusLabel(p.status)}
          </span>
        </div>
      `;

      // AI Summary
      const summaryLines = generateSummary(p);
      document.getElementById('ai-summary-body').innerHTML = summaryLines;

      // Insights
      const insightsList = document.getElementById('insights-list');
      p.ai_insights.forEach(insight => {
        const insightEl = document.createElement('div');
        insightEl.className = `insight-item insight-${insight.type}`;
        insightEl.innerHTML = `
          <div class="insight-item-icon">${getInsightIcon(insight.type)}</div>
          <div class="insight-item-content">
            <strong>${insight.title}</strong>
            <p>${insight.detail}</p>
            <p class="insight-rec">${insight.recommendation}</p>
          </div>
        `;
        insightsList.appendChild(insightEl);
      });

      // Quick stats
      document.getElementById('quick-stats').innerHTML = `
        <h3 class="qstats-title">Quick Overview</h3>
        <div class="qstats-grid">
          <div class="qstat">
            <span class="qstat-label">Total Visits</span>
            <span class="qstat-value">${p.visits.length}</span>
          </div>
          <div class="qstat">
            <span class="qstat-label">Last Visit</span>
            <span class="qstat-value">${p.last_visit}</span>
          </div>
          <div class="qstat">
            <span class="qstat-label">Last BP</span>
            <span class="qstat-value">${lastBP}</span>
          </div>
          <div class="qstat">
            <span class="qstat-label">Doctor</span>
            <span class="qstat-value">${lastVisit.doctor}</span>
          </div>
        </div>
      `;

      // Visits
      document.getElementById('visits-count').textContent = `${p.visits.length} visits`;
      const timeline = document.getElementById('visits-timeline');

      // Render visits in reverse chronological order
      [...p.visits].reverse().forEach((visit, idx) => {
        const tagClass = getTagClass(visit.tag_type);
        const prescriptions = visit.details.prescription
          ? visit.details.prescription.map(rx => `${rx.medicine} ${rx.dosage} ${rx.frequency}`).join('; ')
          : '—';
        const tests = visit.details.tests_ordered && visit.details.tests_ordered.length > 0
          ? visit.details.tests_ordered.join(', ')
          : null;
        const vitals = visit.details.vitals;
        const vitalEntries = Object.entries(vitals).map(([k, v]) => `<span class="vt-chip">${k.toUpperCase()}: ${v}</span>`).join('');

        const card = document.createElement('div');
        card.className = `visit-detail-card ${tagClass}`;
        card.style.animationDelay = `${idx * 100}ms`;
        card.innerHTML = `
          <div class="vd-header">
            <div class="vd-visit-num">Visit ${visit.visit_number}</div>
            <div class="vd-date">${visit.date_display}</div>
            <span class="vd-tag ${tagClass}">${visit.tag}</span>
          </div>
          <div class="vd-vitals">${vitalEntries}</div>
          <div class="vd-sections">
            <div class="vd-section">
              <span class="vd-section-label">Symptoms</span>
              <span class="vd-section-value">${visit.details.symptoms.join(', ')}</span>
            </div>
            <div class="vd-section">
              <span class="vd-section-label">Diagnosis</span>
              <span class="vd-section-value">${visit.details.diagnosis}</span>
            </div>
            <div class="vd-section">
              <span class="vd-section-label">Prescription</span>
              <span class="vd-section-value">${prescriptions}</span>
            </div>
            ${tests ? `
            <div class="vd-section">
              <span class="vd-section-label">Tests</span>
              <span class="vd-section-value">${tests}</span>
            </div>
            ` : ''}
            <div class="vd-section">
              <span class="vd-section-label">Notes</span>
              <span class="vd-section-value">${visit.details.notes}</span>
            </div>
          </div>
          <div class="vd-footer">
            <span>${visit.doctor}</span>
            <span>Follow-up: ${visit.details.follow_up}</span>
          </div>
        `;
        timeline.appendChild(card);
      });

      // Hear AI Summary button
      const hearBtn = document.getElementById('hear-ai-btn');
      if (hearBtn) {
        hearBtn.addEventListener('click', async () => {
          hearBtn.disabled = true;
          hearBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Loading...`;

          try {
            const response = await fetch('/api/summarize', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                patient_history: p.visits,
                doctor_language: p.language
              })
            });
            const data = await response.json();
            if (data.audio) {
              const audio = new Audio('data:audio/wav;base64,' + data.audio);
              hearBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Playing...`;
              audio.play().catch(() => {});
              audio.onended = () => resetHearBtn();
            } else {
              tryPreGenerated();
            }
          } catch {
            tryPreGenerated();
          }

          function tryPreGenerated() {
            const audio = new Audio('audio/summary_kn.wav');
            audio.onerror = () => {
              alert('Summary audio not available. Deploy to Vercel with API key.');
              resetHearBtn();
            };
            audio.oncanplaythrough = () => {
              hearBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Playing...`;
              audio.play().catch(() => {});
            };
            audio.onended = () => resetHearBtn();
            audio.load();
          }

          function resetHearBtn() {
            hearBtn.disabled = false;
            hearBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> Hear Summary`;
          }
        });
      }
    }

    function generateSummary(p) {
      const lastVisit = p.visits[p.visits.length - 1];
      const firstVisit = p.visits[0];
      const allSymptoms = [...new Set(p.visits.flatMap(v => v.details.symptoms))];
      const currentMeds = lastVisit.details.prescription.map(rx => `${rx.medicine} ${rx.dosage}`).join(', ');

      return `
        <p><strong>${p.name}</strong>, ${p.age}-year-old ${p.gender.toLowerCase()}, has been seen
        <strong>${p.visits.length} times</strong> since ${firstVisit.date_display}.</p>
        <p><strong>Current conditions:</strong> ${p.conditions.join(', ')}</p>
        <p><strong>Reported symptoms across visits:</strong> ${allSymptoms.join(', ')}</p>
        <p><strong>Current medications:</strong> ${currentMeds}</p>
        <p><strong>Latest diagnosis:</strong> ${lastVisit.details.diagnosis}</p>
        <p><strong>Follow-up:</strong> ${lastVisit.details.follow_up}</p>
        ${p.ai_insights.filter(i => i.type === 'alert').map(i =>
          `<p class="summary-alert"><strong>Alert:</strong> ${i.detail} — ${i.recommendation}</p>`
        ).join('')}
      `;
    }
  </script>
</body>
</html>
